<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unity Google Login</title>
</head>
<body>
  <h2>Completing Google Login...</h2>
  <pre id="status">üåÄ Opening Google Login...</pre>

  <script>
    // === CONFIG ===
    const HASURA_ENDPOINT = "https://gateway-adventure.hasura.app/v1/graphql"; // Hasura GraphQL endpoint
    const HASURA_ADMIN_SECRET = "YOUR_HASURA_ADMIN_SECRET"; // replace with your admin secret
    const GOOGLE_CLIENT_ID = "226868230614-fmancr9ba24802go0e5q3hgb3ot6qf3g.apps.googleusercontent.com";
    const REDIRECT_URI = "https://gateway-adventure.github.io/gaapp-auth-page/google-auth.html";

    const statusEl = document.getElementById("status");
    const params = new URLSearchParams(window.location.search);

    const uid = params.get("uid");
    const code = params.get("code");

    if (!uid) {
      statusEl.textContent = "‚ùå Missing UID in URL";
      throw new Error("UID missing");
    }

    // Step 1: If no code yet, open Google OAuth
    if (!code) {
      statusEl.textContent = "üåÄ Opening Google Login...";
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI + "?uid=" + uid)}&scope=https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email&access_type=offline&prompt=consent`;
      window.location.href = authUrl;
    } else {
      // Step 2: We have ?code=, send to Hasura
      async function sendCode() {
        try {
          statusEl.textContent = "üîÑ Sending UID + code to Hasura...";

          const mutation = `
            mutation InsertGoogleCode {
              insert_google_codes_one(object: { uid: "${uid}", code: "${code}" }) {
                uid
                code
              }
            }
          `;

          const res = await fetch(HASURA_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-hasura-admin-secret": HASURA_ADMIN_SECRET
            },
            body: JSON.stringify({ query: mutation })
          });

          const data = await res.json();

          if (data.errors) {
            statusEl.textContent = "‚ùå Error sending code:\n" + JSON.stringify(data.errors, null, 2);
            console.error(data.errors);
          } else {
            statusEl.textContent = "‚úÖ Google login complete! Returning to Unity...";

            // Send uid and code back to the opener tab
            if (window.opener) {
              window.opener.postMessage(
                { type: "google-auth-complete", uid, code },
                "*" // You can restrict this to your Unity app's origin
              );
              window.close(); // Optional: close the auth tab
            } else {
              statusEl.textContent += "\n‚ö†Ô∏è Unable to return to Unity tab automatically.";
            }
          }
        } catch (err) {
          statusEl.textContent = "‚ùå Network or CORS error.\n" + err.message;
          console.error(err);
        }
      }

      sendCode();
    }
  </script>
</body>
</html>
