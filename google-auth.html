<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unity Google Login</title>
</head>
<body>
  <h2>Completing Google Login...</h2>
  <pre id="status">üåÄ Preparing login flow...</pre>

  <script>
    const HASURA_ENDPOINT = "https://gateway-adventure.hasura.app/v1/graphql";
    const HASURA_ADMIN_SECRET = "YOUR_HASURA_ADMIN_SECRET"; // Replace with your actual secret

    const statusEl = document.getElementById("status");
    const params = new URLSearchParams(window.location.search);

    const uid = params.get("uid");
    const code = params.get("code");

    if (!uid) {
      statusEl.textContent = "‚ùå Missing UID in URL";
      throw new Error("UID missing");
    }

    if (!code) {
      statusEl.textContent = "üåÄ Redirecting to Google Login...";
      const fullOAuthURL =
        "https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount" +
        "?response_type=code" +
        "&client_id=226868230614-fmancr9ba24802go0e5q3hgb3ot6qf3g.apps.googleusercontent.com" +
        "&redirect_uri=" + encodeURIComponent("https://gateway-adventure.github.io/gaapp-auth-page/google-auth.html?uid=" + uid) +
        "&scope=" + encodeURIComponent("https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email") +
        "&access_type=offline&prompt=consent&service=lso&o2v=2&flowName=GeneralOAuthFlow";

      window.location.href = fullOAuthURL;
    } else {
      async function sendCodeToHasura() {
        try {
          statusEl.textContent = "üîÑ Sending UID + code to Hasura...";

          const mutation = `
            mutation InsertGoogleCode {
              insert_google_codes_one(object: { uid: "${uid}", code: "${code}" }) {
                uid
                code
              }
            }
          `;

          const response = await fetch(HASURA_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-hasura-admin-secret": HASURA_ADMIN_SECRET
            },
            body: JSON.stringify({ query: mutation })
          });

          const result = await response.json();

          if (result.errors) {
            statusEl.textContent = "‚ùå Error sending code:\n" + JSON.stringify(result.errors, null, 2);
            console.error(result.errors);
          } else {
            statusEl.textContent = "‚úÖ Google login complete! You can return to Unity.";
            console.log("Hasura insert result:", result);
          }
        } catch (err) {
          statusEl.textContent = "‚ùå Network or CORS error.\n" + err.message;
          console.error(err);
        }
      }

      sendCodeToHasura();
    }
  </script>
</body>
</html>
