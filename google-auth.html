<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Google Auth</title>
</head>
<body>
  <h3>Completing Google Login...</h3>
  <pre id="status"></pre>

  <script>
    const statusEl = document.getElementById('status');
    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get('uid');

    if (!uid) {
      statusEl.textContent = "❌ Missing UID in URL";
      throw new Error("Missing UID");
    }

    const clientId = "226868230614-fmancr9ba24802go0e5q3hgb3ot6qf3g.apps.googleusercontent.com";
    const redirectUri = "https://gateway-adventure.github.io/gaapp-auth-page/google-callback.html";

    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code`
      + `&client_id=${clientId}`
      + `&redirect_uri=${encodeURIComponent(redirectUri)}`
      + `&scope=${encodeURIComponent("https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email")}`
      + `&access_type=offline&prompt=consent`;

    statusEl.textContent = "🌀 Opening Google Login...";

    // Open popup
    const popup = window.open(authUrl, "_blank", "width=600,height=700");

    // Wait for code from callback page
    window.addEventListener("message", async (event) => {
      if (event.origin !== "https://gateway-adventure.github.io") return;

      if (event.data?.type === "google-auth-code") {
        const code = event.data.code;
        statusEl.textContent = `✅ Got code: ${code}\nUploading...`;

        // Send to Hasura
        const mutation = `
          mutation InsertCode($uid: String!, $code: String!) {
            insert_google_codes_one(
              object: {uid: $uid, code: $code},
              on_conflict: {constraint: google_codes_pkey, update_columns: code}
            ) { uid }
          }`;

        const resp = await fetch("https://gateway-adventureapp.hasura.app/v1/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: mutation, variables: { uid, code } })
        });

        const result = await resp.json();
        statusEl.textContent = "✅ Code saved to Hasura!\nYou can return to Unity.";
      }
    });
  </script>
</body>
</html>
