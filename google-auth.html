<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unity Google Login</title>
</head>
<body>
  <h2>Completing Google Login...</h2>
  <pre id="status">üåÄ Opening Google Login...</pre>

  <script>
    // === CONFIG ===
    const CLIENT_ID = "226868230614-fmancr9ba24802go0e5hgb3ot6qf3g.apps.googleusercontent.com";
    const REDIRECT_URI = "https://gateway-adventure.github.io/gaapp-auth-page/google-auth.html";
    const SCOPE = "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email";

    const status = document.getElementById("status");

    // Get UID from URL
    const params = new URLSearchParams(window.location.search);
    const uid = params.get("uid");
    const code = params.get("code");

    if (!uid) {
      status.textContent = "‚ùå Missing UID in URL";
      throw new Error("Missing UID in URL");
    }

    // If Google redirected back with ?code=..., send to Hasura
    if (code) {
      status.textContent = "üîÑ Sending code to Hasura...";

      const HASURA_ENDPOINT = "https://gatewayadventureapp.hasura.app/v1/graphql";
      const mutation = `
        mutation {
          insert_google_codes_one(object: { uid: "${uid}", code: "${code}" }) {
            uid
            code
          }
        }
      `;

      fetch(HASURA_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // Use a role that can insert anonymously
          "x-hasura-role": "public"
        },
        body: JSON.stringify({ query: mutation })
      })
      .then(res => res.json())
      .then(data => {
        console.log(data);
        if (data.errors) {
          status.textContent = "‚ùå Error sending code:\n" + JSON.stringify(data.errors, null, 2);
        } else {
          status.textContent = "‚úÖ Login complete! You can return to the app.";
        }
      })
      .catch(err => {
        console.error(err);
        status.textContent = "‚ùå Network or CORS error:\n" + err.message;
      });
    } else {
      // Otherwise open Google OAuth page
      status.textContent = "üåÄ Opening Google Login...";

      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
        `?response_type=code` +
        `&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(SCOPE)}` +
        `&access_type=offline` +
        `&prompt=consent`;

      // Redirect browser to Google Login
      window.location.href = authUrl;
    }
  </script>
</body>
</html>
