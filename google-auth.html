<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Google Auth Redirect</title>
</head>
<body>
  <h3>Completing Google Login...</h3>
  <pre id="status"></pre>

  <script>
    const statusEl = document.getElementById('status');
    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get('uid');

    if (!uid) {
      statusEl.textContent = "❌ Missing UID in URL";
      throw new Error("Missing UID in URL");
    }

    const clientId = "226868230614-fmancr9ba24802go0e5q3hgb3ot6qf3g.apps.googleusercontent.com";
    const redirectUri = window.location.origin + window.location.pathname; // same page

    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code`
      + `&client_id=${clientId}`
      + `&redirect_uri=${encodeURIComponent(redirectUri)}`
      + `&scope=${encodeURIComponent("https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email")}`
      + `&access_type=offline&prompt=consent`;

    statusEl.textContent = "🌀 Opening Google Login...";

    // 🔹 Step 1: open Google login in new tab
    const popup = window.open(authUrl, "_blank");

    // 🔹 Step 2: listen for message back from popup
    window.addEventListener("message", async (event) => {
      if (event.data?.type === "google-auth-code") {
        const code = event.data.code;
        statusEl.textContent = `✅ Got code: ${code}\nUploading...`;

        // Upload to Hasura
        const mutation = `
          mutation InsertCode($uid: String!, $code: String!) {
            insert_google_codes_one(object: {uid: $uid, code: $code}, on_conflict: {constraint: google_codes_pkey, update_columns: code}) {
              uid
            }
          }`;

        const resp = await fetch("https://gateway-adventureapp.hasura.app/v1/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: mutation, variables: { uid, code } })
        });

        const result = await resp.json();
        statusEl.textContent = "✅ Code saved to Hasura!\nYou can return to Unity.";
      }
    });

    // 🔹 Step 3: if redirected back here (popup case)
    const code = urlParams.get("code");
    if (code) {
      // send code to opener (main tab)
      if (window.opener) {
        window.opener.postMessage({ type: "google-auth-code", code }, "*");
        window.close();
      } else {
        statusEl.textContent = "✅ Auth completed, you can close this tab.";
      }
    }
  </script>
</body>
</html>
