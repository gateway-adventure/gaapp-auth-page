<!DOCTYPE html>
<html>
<head>
  <title>Gateway Adventure Auth</title>
  <meta charset="UTF-8">
</head>
<body>
  <h2>Completing Google Login...</h2>
  <script>
    async function sendCodeToHasura(uid, code) {
      const mutation = `
        mutation InsertCode($uid: String!, $code: String!) {
          insert_google_codes_one(
            object: { uid: $uid, code: $code },
            on_conflict: { constraint: google_codes_pkey, update_columns: [code] }
          ) {
            uid
            code
          }
        }
      `;

      const response = await fetch("https://gatewayadventureapp.hasura.app/v1/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-hasura-role": "Guest"
        },
        body: JSON.stringify({
          query: mutation,
          variables: { uid, code }
        })
      });

      const result = await response.json();
      console.log("✅ Hasura Response:", result);
      document.body.innerHTML = "<h3>✅ Login complete! You can return to the app.</h3>";
    }

    async function main() {
      const params = new URLSearchParams(window.location.search);
      const uid = params.get("uid");
      const code = params.get("code");

      if (!uid) {
        document.body.innerHTML = "<h3>❌ Missing UID in URL</h3>";
        return;
      }

      if (!code) {
        const clientId = "226868230614-fmancr9ba24802go0e5q3hgb3ot6qf3g.apps.googleusercontent.com";
        const redirectUri = "https://gateway-adventure.github.io/gaapp-auth-page/google-auth.html?uid=" + encodeURIComponent(uid);
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email&access_type=offline&prompt=consent`;
        window.location.href = authUrl;
        return;
      }

      await sendCodeToHasura(uid, code);
    }

    main();
  </script>
</body>
</html>
